#!/usr/bin/env node

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

/**
 * .rbox å£°æ˜Žäº†è¦è¢«æ‰¹é‡å¤„ç†çš„ç›®å½•:
 * {
 *   "enable": [
 *     "vega",
 *     "LVOpenPlugin",
 *     "videoeditor"
 *   ],
 *   "disable": [
 *     "iMovie",
 *     "VideoFusion-win"
 *   ]
 * }
 */
const RBOX_FILE = ".rbox";

/**
 * > rbox --init
 * åˆå§‹åŒ– .rbox file
 */
const init = async () => {
  // å°†ä¸€æ®µæ–‡æœ¬å†™å…¥æŒ‡å®šæ–‡ä»¶ä¸­
  const text = `{
  "enable": [
    "videoeditor",
    "vega"
  ],
  "disable": [
    "iMovie",
    "VideoFusion-win"
  ]
}
`;
  console.log("init .rbox:");
  console.log(text);
  const fileRelativePath = ".rbox";
  const filePath = path.resolve(fileRelativePath);
  fs.writeFileSync(filePath, text);
};

/**
 * ä»Žå½“å‰æ–‡ä»¶å¤¹å‘ä¸ŠæŸ¥æ‰¾ .rbox æ–‡ä»¶
 */
const findRBoxFile = (file) => {
  let currentDir = process.cwd();
  while (currentDir !== "/") {
    const dotFilePath = path.join(currentDir, file);
    if (fs.existsSync(dotFilePath)) {
      return dotFilePath;
    }
    currentDir = path.dirname(currentDir);
  }
  return undefined;
};

/**
 * æ‰§è¡Œå‘½ä»¤
 * @param {string} cmd è¦æ‰§è¡Œçš„å‘½ä»¤
 * @param {string} gitPath Git ä»“åº“è·¯å¾„
 */
const runCommand = (cmd, gitPath) => {
  console.log("-".repeat(80));
  console.warn(`rbox: ${gitPath}\ncmd: ${cmd}`);
  console.log("-".repeat(80));
  if (!fs.existsSync(gitPath)) {
    console.error(`${gitPath} ç›®å½•ä¸å­˜åœ¨`);
    return;
  }
  try {
    execSync(cmd, { cwd: gitPath, stdio: "inherit" });
  } catch (error) {
    console.error("rbox é”™è¯¯:", error);
  }
};

const chalkLog = async () => {
  const chalk = await (await import("chalk")).default;

  const originLog = console.log;
  const originWarn = console.warn;
  const originError = console.error;

  // é‡å†™ console.log æ–¹æ³•
  console.log = function (...args) {
    originLog(chalk.cyan(...args));
  };

  // é‡å†™ console.warn æ–¹æ³•
  console.warn = function (...args) {
    originWarn(chalk.yellow(...args));
  };

  // é‡å†™ console.error æ–¹æ³•
  console.error = function (...args) {
    originError(chalk.red(...args));
  };
};

Promise.resolve().then(async () => {
  await chalkLog();
  try {
    const args = process.argv.slice(2);

    if (args == "--init") {
      await init(".rbox");
      return;
    }
    const rboxFile = findRBoxFile(RBOX_FILE);
    console.log(`.rbox: ${rboxFile}`);
    if (!rboxFile) {
      throw new Error(".rbox æ–‡ä»¶æœªæ‰¾åˆ°!\nåœ¨é€‚å½“çš„ç›®å½•æ‰§è¡Œ: rbox --init ");
    }

    const fileContent = JSON.parse(fs.readFileSync(rboxFile, "utf-8"));
    console.log("content:");
    console.log(JSON.stringify(fileContent, null, 2));
    const gitArray = fileContent.enable;

    const gitPathArray = gitArray.map((e) =>
      path.join(path.dirname(rboxFile), e)
    );
    gitPathArray.forEach((element) => {
      console.log(`ç›®æ ‡ä»“åº“: ${element}`);
    });

    if (args.length === 0) {
      console.log("è¯·è¾“å…¥è¦æ‰¹é‡æ‰§è¡Œçš„å‘½ä»¤. ä¾‹å¦‚ rbox pwd");
      return;
    }
    const cmd = args.join(" ");

    // åœ¨æ¯ä¸ª Git ä»“åº“ä¸­æ‰§è¡Œå‘½ä»¤
    gitPathArray.forEach((gitPath) => {
      runCommand(cmd, gitPath);
    });
    console.info("SUCCESS ðŸŽ‰");
  } catch (e) {
    console.error(e);
    console.error("ABORT ðŸ’¥");
  }
});
